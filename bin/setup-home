#!/bin/bash
# This script does things that cannot be done by git cloning this repo.
set -eu

main() {
    cd "$HOME"
    ensure_dirs
    fix_perms
    setup_git_hooks
}

ensure_dirs() {
    mkdir -p ~/.cache/mpd
    mkdir -p ~/.local/state/mir-flags
    mkdir -p ~/.ssh/ctrl
}

fix_perms() {
    chmod 600 ~/.ssh/config ~/.ssh/config.d/*
}

setup_git_hooks() {
    copy_git_hooks home
    copy_git_hooks elpa .config/emacs/elpa
}

copy_git_hooks() {
    local src=$1
    shift 1
    local dst=
    local hookdir=share/githooks
    for m in $@; do
        dst="${dst}/modules/${m}"
    done
    dst=".git${dst}/hooks"
    if [[ ! -d $dst ]]; then
        printf "Skipping %s because %s is missing\n" "${hookdir}/${src}" "${dst}" >&2
        return 0
    fi
    for x in "${hookdir}/${src}"/*; do
        cp "${x}" "${dst}"
    done
}

main "$@"
